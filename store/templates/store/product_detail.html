{% extends 'main/base.html' %}

{% block content %}
<div class="container">
  <div class="product-details-page">
    <div class="product-details-preview">

      <!-- 📸 Left: Images -->
      <div class="product-image-section">
        <div class="product-image-preview">
          <img id="main-product-img" src="{{ selected_color.images.first.imageURL }}"
            data-default="{{ selected_color.images.first.imageURL }}" width="400" height="400">
        </div>

        <div class="product-thumbnails">
          {% for image in selected_color.images.all %}
          <img src="{{ image.imageURL }}" alt="" width="40" onmouseover="swapMainImage('{{ image.imageURL }}')"
            onmouseout="resetMainImage()">
          {% endfor %}
        </div>
      </div>

      <!-- 📋 Right: Product Info -->
      <div class="product-details-section">
        <h3>{{ product.name }}</h3>
        <h5>{{ product.type.name }} • {{ product.gender.name }}</h5>
        <p id="product-price">
          {% with variant=selected_color.variants.first %}
          {% if variant.sale_price %}
          <strong style="color: red;">KES {{ variant.sale_price }}</strong>
          <span style="text-decoration: line-through; color: gray;">KES {{ variant.price }}</span>
          {% else %}
          <strong>KES {{ variant.price }}</strong>
          {% endif %}
          {% endwith %}
        </p>



        <br>

        <form method="post" action="" id="variant-form">
          {% csrf_token %}

          <h4>Available colors</h4>

          <div class="product-colors">
            {% for color in colors %}
            <img src="{{ color.images.first.imageURL }}" alt="{{ color.color.name }}" title="{{ color.color.name }}"
              width="40" class="color-btn {% if color.id == selected_color.id %}selected{% endif %}"
              style="border-radius: 50%; cursor: pointer;" data-color-id="{{ color.id }}"
              data-image="{{ color.images.first.imageURL }}">
            {% endfor %}
          </div>


          <br>
          <h4>Select Size</h4>
          <select name="variant_id" id="variant-select" required>
            {% for variant in selected_color.variants.all %}
            <option value="{{ variant.id }}">
              Size: {{ variant.size.us_size }} | Stock: {{ variant.stock }} | KES {{ variant.price }}
            </option>
            {% endfor %}
          </select>

          <br><br>
          <label>Quantity:</label>
          <input type="number" name="quantity" value="1" min="1" max="10" step="1">

          <br><br>
          <button type="submit">Add to Cart</button>
        </form>

        <br>
        <p>{{ product.description }}</p>
      </div>
    </div>
  </div>
</div>

<!-- 🧠 Styling -->
<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .product-details-preview {
    display: flex;
    justify-content: space-between;
    gap: 1em;
  }

  .product-image-section {
    width: 45%;
  }

  .product-details-section {
    width: 45%;
  }

  .product-thumbnails img,
  .product-colors img {
    margin-right: 5px;
    border: 1px solid #ccc;
    padding: 2px;
    transition: 0.3s;
  }

  .product-thumbnails img:hover,
  .product-colors img:hover {
    transform: scale(1.1);
    border-color: #222;
  }

  .color-btn.selected {
    border: 2px solid #222;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
  }

  .sale-badge {
    background: red;
    color: white;
    padding: 2px 6px;
    font-size: 0.75rem;
    border-radius: 4px;
    margin-right: 6px;
  }

  .old-price {
    text-decoration: line-through;
    color: gray;
    margin-left: 4px;
  }
</style>

<!-- 📜 Scripts -->
<script>
  function swapMainImage(url) {
    const img = document.getElementById('main-product-img');
    if (img) img.src = url;
  }

  function resetMainImage() {
    const img = document.getElementById('main-product-img');
    if (img) img.src = img.dataset.default;
  }

  function previewColorImage(button) {
    const newImageUrl = button.getAttribute('data-image');
    const img = document.getElementById('main-product-img');
    if (img) img.src = newImageUrl;
  }

  function resetColorImage() {
    const img = document.getElementById('main-product-img');
    if (img) img.src = img.getAttribute('data-default');
  }

  // Color selection (click) → AJAX to get variants
  document.querySelectorAll('.color-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // 🌈 Update .selected swatch
      document.querySelectorAll('.color-btn').forEach(el => el.classList.remove('selected'));
      btn.classList.add('selected');

      const colorId = btn.dataset.colorId;

      fetch(`/ajax/product-color/${colorId}/`)
        .then(res => res.json())
        .then(data => {
          if (data.error) return;

          // 🖼️ Update main image
          const mainImg = document.getElementById('main-product-img');
          mainImg.src = data.images[0];
          mainImg.setAttribute('data-default', data.images[0]);

          // 🖼️ Update thumbnails
          const thumbContainer = document.querySelector('.product-thumbnails');
          thumbContainer.innerHTML = '';
          data.images.forEach(src => {
            const thumb = document.createElement('img');
            thumb.src = src;
            thumb.width = 40;
            thumb.addEventListener('mouseover', () => mainImg.src = src);
            thumb.addEventListener('mouseout', () => mainImg.src = mainImg.dataset.default);
            thumbContainer.appendChild(thumb);
          });

          // 📏 Update size dropdown
          const select = document.getElementById('variant-select');
          select.innerHTML = '';
          data.variants.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.id;
            opt.setAttribute('data-price', v.price);
            opt.setAttribute('data-sale-price', v.sale_price);
            opt.textContent = `Size: ${v.size} | Stock: ${v.stock} | KES ${v.sale_price || v.price}`;
            select.appendChild(opt);
          });

          select.addEventListener('change', (e) => {
            const selected = e.target.selectedOptions[0];
            const variantId = selected.value;
            const price = selected.getAttribute('data-price');
            const salePrice = selected.getAttribute('data-sale-price');
            const stock = selected.textContent.match(/Stock: (\d+)/)[1]; // extract stock

            // 🛒 Update form action
            document.getElementById('variant-form').action = `/cart/add/${variantId}/`;

            // 💰 Update price
            const priceEl = document.getElementById('product-price');
            if (salePrice && salePrice !== 'null') {
              priceEl.innerHTML = `<strong style="color:red;">KES ${salePrice}</strong>
                         <span style="text-decoration: line-through; color: gray;">KES ${price}</span>`;
            } else {
              priceEl.innerHTML = `<strong>KES ${price}</strong>`;
            }

            // 🔢 Update quantity input max
            const qtyInput = document.querySelector('input[name="quantity"]');
            qtyInput.max = stock;
            if (parseInt(qtyInput.value) > parseInt(stock)) {
              qtyInput.value = 1;
            }
          });


          if (data.variants.length > 0) {
            select.dispatchEvent(new Event('change'));
          }


          // 💸 Update price
          const priceEl = document.getElementById('product-price');
          if (data.variants.length > 0) {
            const variant = data.variants[0];
            document.getElementById('variant-form').action = `/cart/add/${variant.id}/`;

            // Check for sale price
            if (variant.sale_price && variant.sale_price !== "null") {
              priceEl.innerHTML = `<strong style="color:red;">KES ${variant.sale_price}</strong>
                                  <span style="text-decoration: line-through; color: gray;">KES ${variant.price}</span>`;
            } else {
              priceEl.innerHTML = `<strong>KES ${variant.price}</strong>`;
            }
          }

        });
    });
  });



</script>
{% endblock %}