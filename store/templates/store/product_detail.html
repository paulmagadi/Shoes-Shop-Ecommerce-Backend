{% extends 'main/base.html' %}

{% block content %}
  <!-- Color selector with data-color-id -->
<div class="color-selector">
  {% for color in colors %}
  <button type="button" class="color-btn" data-color-id="{{ color.id }}">
    <img src="{{ color.images.first.imageURL }}" alt="{{ color.color.name }}" width="40">
  </button>
  {% endfor %}
</div>

<form method="post" action="" id="variant-form">
  {% csrf_token %}

  <label>Select Size:</label>
  <select name="variant_id" id="variant-select" required>
    <!-- will be filled dynamically -->
  </select>

  <label>Quantity:</label>
  <input type="number" name="quantity" value="1" min="1" max="5">

  <button type="submit">Add to Cart</button>
</form>


<script>
  document.querySelectorAll('.color-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const colorId = btn.dataset.colorId;
      fetch(`/ajax/get-variants/${colorId}/`)
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById('variant-select');
          select.innerHTML = ''; // clear old options

          if (data.variants) {
            data.variants.forEach(variant => {
              const opt = document.createElement('option');
              opt.value = variant.id;
              opt.textContent = `Size: ${variant.size} | Stock: ${variant.stock} | KES ${variant.price}`;
              select.appendChild(opt);
            });

            // set form action
            document.getElementById('variant-form').action = `/cart/add/${data.variants[0].id}/`;
          }
        });
    });
  });

  document.getElementById('variant-select').addEventListener('change', (e) => {
    const variantId = e.target.value;
    document.getElementById('variant-form').action = `/cart/add/${variantId}/`;
  });



  fetch(`/cart/add/${variantId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: `quantity=${qty}`
  })
    .then(res => {
      if (res.ok) {
        updateCartIcon();  // 🔁 Refresh icon count
        alert("Item added to cart!");
      }
    });

</script>
{% endblock content %}
  